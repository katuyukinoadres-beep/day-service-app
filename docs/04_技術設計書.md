# 技術設計書

## プロジェクト名
**ぱっと記録（Patto Kiroku）**

---

## 1. 技術スタック

| レイヤー | 技術 | バージョン | 用途 |
|---|---|---|---|
| フレームワーク | Next.js | 16.1.6 | フルスタックReactフレームワーク |
| UIライブラリ | React | 19.2.3 | コンポーネントベースUI |
| 言語 | TypeScript | 5.x | 型安全な開発 |
| スタイリング | Tailwind CSS | 4.x | ユーティリティファーストCSS |
| BaaS | Supabase | - | 認証・データベース・ストレージ |
| Supabase SDK | @supabase/supabase-js | 2.96.0 | Supabaseクライアント |
| SSR対応 | @supabase/ssr | 0.8.0 | サーバーサイドレンダリング用 |
| AI生成 | @anthropic-ai/sdk | - | Claude Sonnet 4.5 APIによる支援記録文章生成 |
| リンター | ESLint | 9.x | コード品質チェック |
| ホスティング | Vercel | - | デプロイ・CDN・エッジ（メイン・Admin 2プロジェクト） |

---

## 2. アーキテクチャ

### 2.1 全体構成

```
┌─────────────┐     ┌──────────────┐     ┌──────────────┐
│   Client     │     │   Vercel     │     │  Supabase    │
│  (Browser)   │◄───►│  (Next.js)   │◄───►│ (PostgreSQL) │
│              │     │              │     │              │
│ React SPA    │     │ App Router   │     │ Auth         │
│ Tailwind CSS │     │ Middleware   │     │ Database     │
│ Supabase SDK │     │ API Routes   │     │ RLS          │
└─────────────┘     └──────┬───────┘     └──────────────┘
                           │
                    ┌──────▼───────┐
                    │ Anthropic API│
                    │ (Claude)     │
                    └──────────────┘
```

### 2.2 Monorepo構成（npm workspaces）

```
day-service-app/
├── apps/
│   ├── main/                  # メインアプリ（スタッフ向け）
│   │   └── src/
│   │       ├── app/
│   │       │   ├── layout.tsx
│   │       │   ├── globals.css
│   │       │   ├── login/
│   │       │   ├── join/
│   │       │   ├── api/generate-record/  # AI文章生成API
│   │       │   ├── record/[childId]/
│   │       │   └── (main)/
│   │       │       ├── layout.tsx
│   │       │       ├── page.tsx
│   │       │       ├── children/
│   │       │       ├── documents/
│   │       │       ├── history/
│   │       │       └── settings/
│   │       ├── components/
│   │       ├── lib/
│   │       └── middleware.ts
│   │
│   └── admin/                 # Admin管理画面（スーパー管理者向け）
│       └── src/
│           ├── app/
│           │   ├── login/
│           │   ├── api/admin-data/    # service_role keyでRLSバイパス
│           │   ├── api/login/
│           │   └── (dashboard)/
│           │       ├── page.tsx       # ダッシュボード
│           │       ├── facilities/    # 施設管理
│           │       ├── users/         # ユーザー管理
│           │       └── reports/       # レポート
│           ├── components/
│           └── lib/
│
├── packages/
│   └── shared/                # 共通パッケージ
│       └── src/
│           ├── types/database.ts    # DB型定義
│           ├── supabase/            # Supabaseクライアント
│           ├── constants.ts
│           └── index.ts
│
├── supabase/migrations/       # DBマイグレーション
├── docs/                      # ドキュメント
└── package.json               # Monorepoルート
```

---

## 3. 認証アーキテクチャ

### 3.1 認証フロー

```
1. ユーザーアクセス
   ↓
2. middleware.ts が実行
   ↓
3. updateSession() で Supabase セッション確認
   ↓
4a. 認証済み → リクエスト続行
4b. 未認証 → /login へリダイレクト
4c. /login で認証済み → / へリダイレクト
```

### 3.2 セッション管理

| 項目 | 内容 |
|---|---|
| 方式 | Cookie ベースセッション |
| ライブラリ | @supabase/ssr |
| ブラウザ側 | `createBrowserClient()` でCookieから自動セッション取得 |
| サーバー側 | `createServerClient()` で next/headers の cookies を使用 |
| ミドルウェア | リクエストごとにセッション更新（トークンリフレッシュ） |

### 3.3 Supabaseクライアント構成

**ブラウザクライアント** (`lib/supabase/client.ts`):
```typescript
createBrowserClient<Database>(
  NEXT_PUBLIC_SUPABASE_URL,
  NEXT_PUBLIC_SUPABASE_ANON_KEY
)
```

**サーバークライアント** (`lib/supabase/server.ts`):
```typescript
createServerClient<Database>(
  NEXT_PUBLIC_SUPABASE_URL,
  NEXT_PUBLIC_SUPABASE_ANON_KEY,
  { cookies: cookieStore }
)
```

---

## 4. データアクセスパターン

### 4.1 クライアントサイドデータフェッチ

すべてのページは `"use client"` ディレクティブを使用し、`useEffect` 内で Supabase クライアントを通じてデータを取得する。

```
コンポーネントマウント
  → useEffect 発火
  → createClient() でSupabaseクライアント生成
  → Promise.all で並列データ取得
  → setState でローカル状態更新
  → UI再レンダリング
```

### 4.2 データ取得の最適化
- **並列フェッチ**: `Promise.all` で複数テーブルのデータを同時取得
- **RLSによる自動フィルタ**: `facility_id` のフィルタリングはRLSで自動適用
- **is_active フィルタ**: 児童一覧では `is_active = true` でフィルタ

### 4.3 データ書き込みパターン

```
ユーザー操作（フォーム送信）
  → createClient() でクライアント生成
  → auth.getUser() で現在ユーザー取得
  → profiles テーブルから facility_id 取得
  → データオブジェクト構築
  → insert() or update() 実行
  → router.push() or router.replace() で画面遷移
  → router.refresh() でサーバー状態更新
```

---

## 5. ルーティング・ミドルウェア

### 5.1 ミドルウェア設定

```typescript
// マッチャー: 静的アセットを除くすべてのパス
matcher: [
  "/((?!_next/static|_next/image|favicon.ico|icons|manifest.json|sw.js).*)"
]
```

### 5.2 ルートグループ

| グループ | パス | 特徴 |
|---|---|---|
| (パブリック) | `/login`, `/join` | 認証不要 |
| (main) | `/`, `/children`, `/documents`, etc. | BottomNav付き、認証必要 |
| (ダイレクト) | `/record/[childId]` | BottomNavなし、認証必要 |

---

## 6. 状態管理

### 6.1 方針
- **サーバー状態**: Supabase からの直接フェッチ（グローバル状態管理ライブラリ不使用）
- **ローカル状態**: React `useState` でフォーム状態管理
- **認証状態**: Supabase Auth + Cookie セッション
- **プロフィール情報**: `useProfile` カスタムフック

### 6.2 useProfile フック

```typescript
interface UseProfileResult {
  profile: Profile | null;
  isAdmin: boolean;
  loading: boolean;
}
```

- コンポーネントマウント時に `profiles` テーブルから現在ユーザーのプロフィールを取得
- `role === "admin"` で管理者判定
- admin限定ページの表示制御に使用

---

## 7. スタイリング

### 7.1 Tailwind CSS 4 構成

```css
/* globals.css */
@import "tailwindcss";

@theme {
  --color-primary: #1B6B4A;
  --color-primary-light: #E8F5EE;
  --color-accent: #E8913A;
  --color-accent-light: #FFF3E6;
  /* ... */
}
```

### 7.2 レスポンシブ設計
- **モバイルファースト**: デスクトップブレイクポイントなし（モバイル専用設計）
- **PWA対応**: セーフエリアインセット、テーマカラー設定
- **タップターゲット**: 最小44px確保（`.tap-target`クラス）

### 7.3 印刷対応
- `print:` Tailwindバリアントで印刷時スタイル制御
- `.no-print` / `.print-only` ユーティリティクラス
- A4用紙サイズ対応の@pageルール

---

## 8. 環境変数

### 8.1 メインアプリ（apps/main）
| 変数名 | 説明 | 公開範囲 |
|---|---|---|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase プロジェクトURL | クライアント + サーバー |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase匿名キー | クライアント + サーバー |
| `ANTHROPIC_API_KEY` | Anthropic API キー（AI文章生成用） | サーバーのみ |

### 8.2 Admin管理画面（apps/admin）
| 変数名 | 説明 | 公開範囲 |
|---|---|---|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase プロジェクトURL | クライアント + サーバー |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase匿名キー | クライアント + サーバー |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase service role キー（RLSバイパス用） | サーバーのみ |
| `ADMIN_PASSWORD` | Admin ログインパスワード | サーバーのみ |

---

## 9. デプロイ構成

### 9.1 Vercel デプロイ（2プロジェクト構成）

| プロジェクト | アプリ | Root Directory |
|---|---|---|
| day-service-app | メインアプリ | `apps/main` |
| day-service-admin | Admin管理画面 | `apps/admin` |

### 9.2 ビルド・開発コマンド

| コマンド | 説明 |
|---|---|
| `npm run dev:main` | メインアプリ開発サーバー起動 |
| `npm run dev:admin` | Admin開発サーバー起動 |
| `npm run build:main` | メインアプリのビルド |
| `npm run build:admin` | Adminのビルド |

---

## 10. パフォーマンス最適化

### 10.1 実施済み
- **並列データフェッチ**: `Promise.all` による同時取得
- **クライアントサイドルーティング**: Next.js App Routerによる高速遷移
- **フォント最適化**: `next/font` による Noto Sans JP の最適読み込み
- **CSS最適化**: Tailwind CSS のパージによる未使用CSS除去

### 10.2 今後の検討事項
- Server Components の活用（現在はすべて Client Components）
- データフェッチのキャッシュ戦略（SWR / React Query の導入検討）
- 画像最適化（`next/image` の活用）
- バンドルサイズの最適化（動的インポート）

---

## 11. エラーハンドリング方針

| レイヤー | 方針 |
|---|---|
| 認証エラー | ミドルウェアでリダイレクト |
| データ取得エラー | ローディング状態表示、空データでフォールバック |
| データ書き込みエラー | アラート表示（現状）→ トースト通知（改善案） |
| AI生成エラー | アラート表示（APIエラー、ネットワークエラー） |
| ネットワークエラー | Supabase SDK のリトライ機構に依存 |

---

## 12. ディレクトリ規約

| ディレクトリ | 規約 |
|---|---|
| `app/` | ページコンポーネント（Next.js App Router規約） |
| `components/ui/` | 汎用UIコンポーネント（プレゼンテーショナル） |
| `components/` | 機能コンポーネント（BottomNav等） |
| `lib/` | ユーティリティ、フック、外部サービスクライアント |
| `types/` | TypeScript型定義 |

### ファイル命名規約
- コンポーネント: PascalCase（`Button.tsx`, `Card.tsx`）
- ページ: `page.tsx`（Next.js規約）
- レイアウト: `layout.tsx`（Next.js規約）
- フック: camelCase、`use` プレフィックス（`useProfile.ts`）
- 定数: camelCase（`constants.ts`）
- 型定義: camelCase（`database.ts`）
