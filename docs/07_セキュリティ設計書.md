# セキュリティ設計書

## プロジェクト名
**ぱっと記録（Patto Kiroku）**

---

## 1. セキュリティ概要

本アプリケーションは児童の個人情報を扱うため、適切なセキュリティ対策を講じる。Supabase の認証基盤と PostgreSQL の RLS を活用し、多層的なセキュリティを実現する。

---

## 2. 認証セキュリティ

### 2.1 認証方式
| 項目 | 内容 |
|---|---|
| 認証プロバイダ | Supabase Auth |
| 認証方式 | メール / パスワード |
| パスワード要件 | 最小6文字 |
| セッション管理 | JWT + Cookie |
| トークンリフレッシュ | ミドルウェアで自動実行 |

### 2.2 セッション管理
- **JWT（JSON Web Token）** による認証
- Cookie に `httpOnly` でトークンを保存
- ミドルウェアでリクエストごとにトークンの有効性を検証
- トークン有効期限切れ時は自動リフレッシュ
- ログアウト時にサーバー側でセッション無効化

### 2.3 パスワードセキュリティ
- Supabase Auth によるパスワードハッシュ化（bcrypt）
- パスワードはプレーンテキストで保存されない
- 最小パスワード長: 6文字

---

## 3. 認可（アクセス制御）

### 3.1 ロールベースアクセス制御（RBAC）

| 機能 | admin | staff |
|---|---|---|
| 日次記録の入力・編集 | ○ | ○ |
| 児童の登録・編集 | ○ | ○ |
| 帳票の閲覧・印刷 | ○ | ○ |
| フレーズの管理 | ○ | ○ |
| 記録履歴の閲覧・削除 | ○ | ○ |
| 施設設定の変更 | ○ | × |
| スタッフの管理 | ○ | × |
| ロールの変更 | ○ | × |
| 招待リンクの生成 | ○ | × |

### 3.2 アクセス制御の実装レイヤー

```
1. ミドルウェア層（Next.js Middleware）
   → 未認証ユーザーを /login へリダイレクト

2. アプリケーション層（useProfile フック）
   → isAdmin フラグで管理者限定UIの表示/非表示制御
   → staff ユーザーは管理者ページから /settings にリダイレクト

3. データベース層（RLS）
   → facility_id による施設間データ分離
   → ユーザーは自施設のデータのみアクセス可能
```

---

## 4. データ保護

### 4.1 マルチテナント分離

```sql
-- すべてのデータテーブルに RLS ポリシーを適用
-- ユーザーの facility_id と一致するレコードのみアクセス可能
CREATE POLICY "facility_isolation"
  ON {table_name} FOR ALL
  USING (
    facility_id = (
      SELECT facility_id FROM profiles
      WHERE id = auth.uid()
    )
  );
```

### 4.2 データ分類

| データカテゴリ | 該当データ | 機密レベル |
|---|---|---|
| 個人情報 | 児童の氏名、生年月日、学校 | 高 |
| 支援情報 | 支援記録、気分、活動内容 | 高 |
| ユーザー情報 | メールアドレス、表示名 | 中 |
| 施設情報 | 施設名 | 低 |
| マスタデータ | フレーズバンク | 低 |

### 4.3 個人情報保護対策
- データベースの暗号化（Supabase の保管時暗号化）
- HTTPS による通信暗号化（TLS 1.2/1.3）
- 児童の物理削除禁止（論理削除: `is_active = false`）
- アクセスログの記録（Supabase ダッシュボード）

---

## 5. 通信セキュリティ

### 5.1 HTTPS
- すべての通信を HTTPS で暗号化
- Vercel / Supabase ともに自動 SSL 証明書
- HTTP → HTTPS の自動リダイレクト

### 5.2 APIセキュリティ
| 対策 | 内容 |
|---|---|
| 認証 | Bearer Token（JWT） |
| CORS | Supabase ダッシュボードで許可オリジン設定 |
| Rate Limiting | Supabase のデフォルトレート制限 |
| API Key | `anon` キー（公開用）のみクライアントで使用 |
| Service Role Key | サーバーサイドのみ、クライアントに露出しない |

---

## 6. フロントエンドセキュリティ

### 6.1 XSS（クロスサイトスクリプティング）対策
- React の自動エスケープ機能
- `dangerouslySetInnerHTML` を使用しない
- ユーザー入力値を直接DOMに挿入しない

### 6.2 CSRF（クロスサイトリクエストフォージェリ）対策
- Supabase Auth の JWT トークンによる保護
- Cookie に SameSite 属性を設定

### 6.3 環境変数管理
| 変数 | 公開範囲 | 機密性 |
|---|---|---|
| `NEXT_PUBLIC_SUPABASE_URL` | クライアント + サーバー | 低（公開可） |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | クライアント + サーバー | 低（RLSで保護） |
| `SUPABASE_SERVICE_ROLE_KEY` | サーバーのみ | 高（非公開必須） |

---

## 7. インフラセキュリティ

### 7.1 Vercel
- 自動 SSL/TLS
- DDoS 保護
- エッジネットワーク
- 環境変数の暗号化保存

### 7.2 Supabase
- PostgreSQL の暗号化ストレージ
- 自動バックアップ
- ネットワーク分離
- ダッシュボードの2FA対応

---

## 8. インシデント対応

### 8.1 対応フロー
1. インシデント検知（ログ監視、ユーザー報告）
2. 影響範囲の特定
3. 一時対応（該当アカウントの無効化等）
4. 原因調査
5. 恒久対策の実施
6. 関係者への通知

### 8.2 ログ・監査
| ログ種別 | 保存場所 | 保持期間 |
|---|---|---|
| 認証ログ | Supabase Auth Logs | 7日間（Free） |
| APIリクエストログ | Supabase API Logs | 7日間（Free） |
| データベースログ | Supabase DB Logs | 7日間（Free） |
| アプリケーションログ | Vercel Logs | 1時間（Free） |

---

## 9. セキュリティチェックリスト

| # | 項目 | 状態 |
|---|---|---|
| 1 | HTTPS通信の強制 | ○ |
| 2 | パスワードのハッシュ化 | ○（Supabase Auth） |
| 3 | RLSによるデータ分離 | ○ |
| 4 | ミドルウェアでの認証チェック | ○ |
| 5 | 環境変数でのシークレット管理 | ○ |
| 6 | XSS対策（React自動エスケープ） | ○ |
| 7 | CSRF対策（JWT + SameSite Cookie） | ○ |
| 8 | SQLインジェクション対策（パラメタライズドクエリ） | ○（Supabase SDK） |
| 9 | Service Role Key の非公開 | ○ |
| 10 | 児童データの物理削除禁止 | ○ |
