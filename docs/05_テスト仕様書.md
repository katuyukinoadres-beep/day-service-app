# テスト仕様書

## プロジェクト名
**ぱっと記録（Patto Kiroku）**

---

## 1. テスト方針

### 1.1 テスト戦略
本プロジェクトでは以下のテストレベルを段階的に実施する。

| テストレベル | 目的 | ツール |
|---|---|---|
| ユニットテスト | 個別関数・ロジックの正当性検証 | Jest / Vitest |
| コンポーネントテスト | UIコンポーネントの表示・動作検証 | React Testing Library |
| E2Eテスト | ユーザー操作シナリオの検証 | Playwright |
| 手動テスト | UI/UX、印刷、レスポンシブ確認 | ブラウザ |

### 1.2 テスト優先度
- **P1（必須）**: 認証、データ登録・更新、帳票出力
- **P2（重要）**: 画面遷移、バリデーション、ロール制御
- **P3（推奨）**: UI表示、レスポンシブ、パフォーマンス

---

## 2. 機能テストケース

### 2.1 認証 (AUTH)

| ID | テスト項目 | 操作手順 | 期待結果 | 優先度 |
|---|---|---|---|---|
| AUTH-T001 | 新規登録（正常） | 施設名・表示名・メール・パスワードを入力し「登録する」をタップ | 施設が作成され、adminロールでホームに遷移 | P1 |
| AUTH-T002 | 新規登録（メール重複） | 既存メールで登録を試行 | エラーメッセージが表示される | P1 |
| AUTH-T003 | 新規登録（パスワード短い） | 5文字以下のパスワードで登録を試行 | エラーメッセージが表示される | P2 |
| AUTH-T004 | ログイン（正常） | 正しいメール・パスワードを入力し「ログイン」をタップ | ホーム画面に遷移 | P1 |
| AUTH-T005 | ログイン（認証失敗） | 誤ったパスワードでログインを試行 | エラーメッセージが表示される | P1 |
| AUTH-T006 | ログアウト | 設定画面で「ログアウト」をタップ | ログイン画面に遷移、セッションが無効化 | P1 |
| AUTH-T007 | スタッフ招待参加 | 招待リンクからアクセスし、登録 | staffロールで同一施設に登録される | P1 |
| AUTH-T008 | 未認証アクセス | ログインせずに `/` にアクセス | `/login` にリダイレクトされる | P1 |
| AUTH-T009 | 認証済みで/loginアクセス | ログイン状態で `/login` にアクセス | `/` にリダイレクトされる | P2 |

---

### 2.2 児童管理 (CHILD)

| ID | テスト項目 | 操作手順 | 期待結果 | 優先度 |
|---|---|---|---|---|
| CHILD-T001 | 児童一覧表示 | 児童タブをタップ | 有効な児童が五十音順で表示される | P1 |
| CHILD-T002 | 児童新規登録 | 名前を入力し「保存」をタップ | 児童が登録され一覧に表示される | P1 |
| CHILD-T003 | 児童登録（名前なし） | 名前を空で「保存」をタップ | バリデーションエラーが表示される | P2 |
| CHILD-T004 | 児童情報編集 | 既存児童をタップし、学校名を変更して保存 | 変更が反映される | P1 |
| CHILD-T005 | 児童無効化 | 児童編集画面で「有効」をOFFにして保存 | 児童一覧から非表示になる | P1 |
| CHILD-T006 | アイコン色設定 | 色を選択して保存 | 選択した色でアバターが表示される | P3 |
| CHILD-T007 | 支援領域タグ設定 | 複数のタグを選択して保存 | 記録画面でフレーズがハイライトされる | P2 |
| CHILD-T008 | 個別目標追加・削除 | 目標を追加・削除して保存 | 帳票に反映される | P2 |

---

### 2.3 日次記録 (REC)

| ID | テスト項目 | 操作手順 | 期待結果 | 優先度 |
|---|---|---|---|---|
| REC-T001 | 新規記録作成 | ホームで未記録児童をタップ、各項目を入力して保存 | 記録が保存され、ホームで「記録済み」に移動 | P1 |
| REC-T002 | 来所時刻の初期値 | 未記録児童の記録画面を開く | 現在時刻が来所時刻にプリセットされる | P2 |
| REC-T003 | 気分選択 | 3つの気分ボタンから1つを選択 | 選択した気分がハイライトされる | P2 |
| REC-T004 | 活動複数選択 | 複数の活動チップをタップ | 複数選択が可能、再タップで解除 | P1 |
| REC-T005 | フレーズ選択 | フレーズをタップして選択 | チェックマーク付きでハイライト表示 | P1 |
| REC-T006 | フレーズ優先表示 | 支援領域タグが設定された児童の記録画面を開く | 該当タグのフレーズが黄色ハイライト＋上位表示 | P2 |
| REC-T007 | 既存記録の編集 | 記録済み児童をタップ | 既存データが復元され「編集中」バッジが表示される | P1 |
| REC-T008 | 自動遷移（次の児童） | 記録保存後 | 次の未記録児童の記録画面に自動遷移 | P1 |
| REC-T009 | 自動遷移（全員完了） | 最後の未記録児童の記録を保存 | ホーム画面に遷移 | P1 |
| REC-T010 | 送迎方法の単一選択 | 送迎方法チップをタップ | 1つのみ選択可能、再タップで解除 | P2 |
| REC-T011 | メモ入力 | テキストエリアに自由記述 | 入力した内容が保存される | P2 |

---

### 2.4 記録履歴 (HIST)

| ID | テスト項目 | 操作手順 | 期待結果 | 優先度 |
|---|---|---|---|---|
| HIST-T001 | 履歴一覧表示 | 履歴タブをタップ | 最近の記録が一覧表示される | P1 |
| HIST-T002 | 日付フィルタ | 日付を選択 | 選択日の記録のみ表示 | P2 |
| HIST-T003 | 児童フィルタ | 児童を選択 | 選択児童の記録のみ表示 | P2 |
| HIST-T004 | 記録編集 | 編集ボタンをタップ | 記録入力画面で既存データが復元される | P1 |
| HIST-T005 | 記録削除 | 削除ボタンをタップし確認 | 記録が削除される | P1 |

---

### 2.5 帳票出力 (DOC)

| ID | テスト項目 | 操作手順 | 期待結果 | 優先度 |
|---|---|---|---|---|
| DOC-T001 | 業務日誌表示 | 日付を選択 | 当日の全記録が表形式で表示される | P1 |
| DOC-T002 | 業務日誌印刷 | 印刷ボタンをタップ | ブラウザの印刷ダイアログが開き、A4縦で適切にレイアウト | P1 |
| DOC-T003 | 業務日誌（記録なし） | 記録のない日を選択 | 「記録がありません」メッセージが表示される | P2 |
| DOC-T004 | サービス提供記録表示 | 日付と児童を選択 | 個別の支援記録が帳票形式で表示される | P1 |
| DOC-T005 | サービス提供記録（児童情報） | サービス提供記録を表示 | 児童の基本情報（名前、生年月日、学校、目標、領域タグ）が表示される | P1 |
| DOC-T006 | サービス提供記録印刷 | 印刷ボタンをタップ | A4縦で適切にレイアウト、署名欄付き | P1 |
| DOC-T007 | 月間出席サマリー表示 | 月を選択 | カレンダーグリッドで出席状況が表示される | P1 |
| DOC-T008 | 月間出席サマリー印刷 | 印刷ボタンをタップ | A4横で適切にレイアウト | P1 |

---

### 2.6 フレーズ管理 (PHR)

| ID | テスト項目 | 操作手順 | 期待結果 | 優先度 |
|---|---|---|---|---|
| PHR-T001 | フレーズ一覧表示 | 設定 > フレーズ管理を開く | カテゴリ別にフレーズが表示される | P2 |
| PHR-T002 | デフォルトフレーズ | デフォルトフレーズをタップ | 編集不可（「デフォルト」バッジ表示） | P2 |
| PHR-T003 | カスタムフレーズ追加 | 「+追加」をタップ、内容を入力して保存 | フレーズが追加され一覧に表示される | P2 |
| PHR-T004 | カスタムフレーズ編集 | カスタムフレーズをタップし編集 | 変更が反映される | P2 |

---

### 2.7 設定・ロール制御 (SET)

| ID | テスト項目 | 操作手順 | 期待結果 | 優先度 |
|---|---|---|---|---|
| SET-T001 | プロフィール表示名変更 | 表示名を変更して保存 | 変更が反映される | P2 |
| SET-T002 | 施設設定（admin） | 施設名を変更して保存 | 変更が反映される | P2 |
| SET-T003 | 施設設定（staff不可） | staffロールで施設設定にアクセス | アクセス不可（リダイレクト or 非表示） | P1 |
| SET-T004 | スタッフ管理（admin） | スタッフ一覧を表示 | 施設のスタッフ一覧が表示される | P2 |
| SET-T005 | ロール変更 | スタッフのロール変更ボタンをタップ | admin ↔ staff が切り替わる | P2 |
| SET-T006 | 自身のロール変更不可 | 自分自身のロール変更を試行 | 変更ボタンが無効化されている | P2 |
| SET-T007 | 招待リンク生成 | 招待ページを開く | 施設IDを含む招待URLが表示される | P2 |
| SET-T008 | 招待リンクコピー | コピーボタンをタップ | クリップボードにURLがコピーされる | P3 |

---

## 3. マルチテナント分離テスト

| ID | テスト項目 | 操作手順 | 期待結果 | 優先度 |
|---|---|---|---|---|
| MT-T001 | 施設間データ分離 | 施設Aのユーザーでログインし児童一覧を表示 | 施設Aの児童のみ表示される（施設Bのデータは非表示） | P1 |
| MT-T002 | 他施設データ直接アクセス | Supabase APIで他施設の child_id を指定してクエリ | RLSにより空結果が返却される | P1 |
| MT-T003 | 他施設記録への書き込み | 他施設の child_id で日次記録を作成試行 | RLSによりエラーが返却される | P1 |

---

## 4. レスポンシブ・UIテスト

| ID | テスト項目 | 対象端末 | 確認事項 | 優先度 |
|---|---|---|---|---|
| UI-T001 | iPhone SE表示 | 375×667px | レイアウト崩れなし、タップターゲット44px以上 | P2 |
| UI-T002 | iPhone 14表示 | 390×844px | レイアウト崩れなし、セーフエリア対応 | P2 |
| UI-T003 | iPad表示 | 768×1024px | 基本的なレイアウトが維持される | P3 |
| UI-T004 | デスクトップ表示 | 1440×900px | 最低限の表示崩れなし | P3 |
| UI-T005 | 印刷プレビュー | 全帳票画面 | A4用紙に適切に収まる | P1 |

---

## 5. パフォーマンステスト

| ID | テスト項目 | 計測方法 | 目標値 | 優先度 |
|---|---|---|---|---|
| PERF-T001 | 初期ロード時間 | Lighthouse | FCP < 2秒 | P2 |
| PERF-T002 | ホーム画面データ読み込み | DevTools Network | < 1秒 | P2 |
| PERF-T003 | 記録保存レスポンス | DevTools Network | < 500ms | P2 |
| PERF-T004 | 画面遷移速度 | 体感計測 | < 300ms | P3 |

---

## 6. セキュリティテスト

| ID | テスト項目 | 確認方法 | 期待結果 | 優先度 |
|---|---|---|---|---|
| SEC-T001 | 認証なしAPIアクセス | Supabase APIを認証トークンなしで呼び出し | 401エラーが返却 | P1 |
| SEC-T002 | RLS有効性 | 他施設ユーザーのトークンでデータ取得試行 | 空結果またはエラー | P1 |
| SEC-T003 | XSS防止 | メモ欄にスクリプトタグを入力 | HTMLエスケープされて表示 | P1 |
| SEC-T004 | HTTPS通信 | ブラウザ開発者ツール | すべての通信がHTTPS | P1 |
| SEC-T005 | 環境変数の非公開確認 | ブラウザソースコード | `SUPABASE_SERVICE_ROLE_KEY` 等が露出していない | P1 |

---

## 7. テスト環境

| 項目 | 内容 |
|---|---|
| テスト用Supabaseプロジェクト | 本番とは別のプロジェクトを使用 |
| テストデータ | シードスクリプトで初期データ投入 |
| ブラウザ | Chrome（最新）、Safari（最新） |
| デバイス | iPhone実機 or Chrome DevToolsエミュレーション |
