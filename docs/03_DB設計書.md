# DB設計書

## プロジェクト名
**ぱっと記録（Patto Kiroku）**

---

## 1. データベース概要

| 項目 | 内容 |
|---|---|
| DBMS | PostgreSQL（Supabase マネージド） |
| スキーマ | public |
| 文字コード | UTF-8 |
| タイムゾーン | UTC（アプリ側でJST変換） |
| マルチテナント方式 | facility_id による論理分離 + RLS |

---

## 2. ER図

```
┌──────────┐       ┌──────────────┐
│ facilities│◄──┐  │   profiles    │
│──────────│   │  │──────────────│
│ id (PK)  │   ├──│ facility_id   │
│ name     │   │  │ id (PK/FK)   │
│ created_at│  │  │ display_name  │
└──────────┘   │  │ role          │
               │  │ created_at    │
               │  └──────────────┘
               │
               │  ┌──────────────┐
               ├──│   children    │
               │  │──────────────│
               │  │ id (PK)      │
               │  │ facility_id   │
               │  │ name          │
               │  │ name_kana     │
               │  │ birth_date    │
               │  │ school        │
               │  │ grade         │
               │  │ icon_color    │
               │  │ goals[]       │
               │  │ domain_tags[] │
               │  │ is_active     │
               │  │ created_at    │
               │  │ updated_at    │
               │  └──────┬───────┘
               │         │
               │         │  ┌───────────────┐
               │         ├──│ daily_records  │
               │         │  │───────────────│
               │         │  │ id (PK)       │
               ├─────────┤  │ facility_id    │
               │         │  │ child_id (FK)  │
               │         │  │ date           │
               │         │  │ mood           │
               │         │  │ activities[]   │
               │         │  │ phrases[]      │
               │         │  │ memo           │
               │         │  │ arrival_time   │
               │         │  │ departure_time │
               │         │  │ pickup_method  │
               │         │  │ recorded_by    │
               │         │  │ created_at     │
               │         │  │ updated_at     │
               │         │  └───────────────┘
               │         │
               │         │  ┌───────────────┐
               │         └──│  attendances   │
               │            │───────────────│
               ├────────────│ id (PK)       │
                            │ facility_id    │
                            │ child_id (FK)  │
                            │ date           │
                            │ is_present     │
                            │ created_at     │
                            └───────────────┘

               ┌───────────────┐
               │  phrase_bank   │
               │───────────────│
               │ id (PK)       │
          ┌────│ facility_id    │
          │    │ category       │
          │    │ text           │
          │    │ domain_tags[]  │
          │    │ sort_order     │
          │    │ is_default     │
          │    │ created_at     │
          │    └───────────────┘
          │
          └──── facilities.id (nullable: デフォルトフレーズはNULL)
```

---

## 3. テーブル定義

### 3.1 facilities（施設）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---|---|---|---|---|
| id | UUID | NOT NULL | `gen_random_uuid()` | 主キー |
| name | TEXT | NOT NULL | - | 施設名 |
| created_at | TIMESTAMPTZ | NOT NULL | `now()` | 作成日時 |

**制約**:
- PRIMARY KEY: `id`

**インデックス**: なし（主キーのみ）

---

### 3.2 profiles（ユーザープロフィール）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---|---|---|---|---|
| id | UUID | NOT NULL | - | 主キー（auth.users.id と一致） |
| facility_id | UUID | NOT NULL | - | 所属施設ID |
| display_name | TEXT | NOT NULL | - | 表示名 |
| role | TEXT | NOT NULL | `'staff'` | ロール（'admin' / 'staff'） |
| created_at | TIMESTAMPTZ | NOT NULL | `now()` | 作成日時 |

**制約**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `facility_id` → `facilities(id)`
- FOREIGN KEY: `id` → `auth.users(id)` ON DELETE CASCADE
- CHECK: `role IN ('admin', 'staff')`

**インデックス**:
- `idx_profiles_facility_id` ON `facility_id`

---

### 3.3 children（児童）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---|---|---|---|---|
| id | UUID | NOT NULL | `gen_random_uuid()` | 主キー |
| facility_id | UUID | NOT NULL | - | 所属施設ID |
| name | TEXT | NOT NULL | - | 氏名 |
| name_kana | TEXT | NULL | NULL | ふりがな |
| birth_date | DATE | NULL | NULL | 生年月日 |
| school | TEXT | NULL | NULL | 学校名 |
| grade | TEXT | NULL | NULL | 学年 |
| icon_color | TEXT | NOT NULL | `'#1B6B4A'` | アイコン背景色（HEX） |
| goals | TEXT[] | NOT NULL | `'{}'` | 個別支援目標 |
| domain_tags | TEXT[] | NOT NULL | `'{}'` | 支援領域タグ |
| is_active | BOOLEAN | NOT NULL | `TRUE` | 有効フラグ（論理削除用） |
| created_at | TIMESTAMPTZ | NOT NULL | `now()` | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | `now()` | 更新日時 |

**制約**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `facility_id` → `facilities(id)`

**インデックス**:
- `idx_children_facility_id` ON `facility_id`
- `idx_children_is_active` ON `facility_id, is_active`
- `idx_children_name_kana` ON `facility_id, name_kana`

**トリガー**:
- `updated_at` を更新時に自動設定

---

### 3.4 daily_records（日次記録）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---|---|---|---|---|
| id | UUID | NOT NULL | `gen_random_uuid()` | 主キー |
| facility_id | UUID | NOT NULL | - | 施設ID |
| child_id | UUID | NOT NULL | - | 児童ID |
| date | DATE | NOT NULL | - | 記録日 |
| mood | TEXT | NULL | NULL | 気分（'good'/'neutral'/'bad'） |
| activities | TEXT[] | NOT NULL | `'{}'` | 活動内容 |
| phrases | TEXT[] | NOT NULL | `'{}'` | 選択フレーズ |
| memo | TEXT | NULL | NULL | 自由記述メモ |
| arrival_time | TIME | NULL | NULL | 来所時刻 |
| departure_time | TIME | NULL | NULL | 退所時刻 |
| pickup_method | TEXT | NULL | NULL | 送迎方法 |
| recorded_by | UUID | NULL | NULL | 記録者（profiles.id） |
| created_at | TIMESTAMPTZ | NOT NULL | `now()` | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | `now()` | 更新日時 |

**制約**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `facility_id` → `facilities(id)`
- FOREIGN KEY: `child_id` → `children(id)`
- FOREIGN KEY: `recorded_by` → `profiles(id)`
- UNIQUE: `(child_id, date)` — 1児童1日1レコード
- CHECK: `mood IN ('good', 'neutral', 'bad')` OR NULL

**インデックス**:
- `idx_daily_records_facility_date` ON `facility_id, date`
- `idx_daily_records_child_date` ON `child_id, date`

**トリガー**:
- `updated_at` を更新時に自動設定

---

### 3.5 attendances（出席）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---|---|---|---|---|
| id | UUID | NOT NULL | `gen_random_uuid()` | 主キー |
| facility_id | UUID | NOT NULL | - | 施設ID |
| child_id | UUID | NOT NULL | - | 児童ID |
| date | DATE | NOT NULL | - | 日付 |
| is_present | BOOLEAN | NOT NULL | `TRUE` | 出席フラグ |
| created_at | TIMESTAMPTZ | NOT NULL | `now()` | 作成日時 |

**制約**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `facility_id` → `facilities(id)`
- FOREIGN KEY: `child_id` → `children(id)`
- UNIQUE: `(child_id, date)` — 1児童1日1レコード

**インデックス**:
- `idx_attendances_facility_date` ON `facility_id, date`
- `idx_attendances_child_date` ON `child_id, date`

---

### 3.6 phrase_bank（フレーズバンク）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---|---|---|---|---|
| id | UUID | NOT NULL | `gen_random_uuid()` | 主キー |
| facility_id | UUID | NULL | NULL | 施設ID（NULL=デフォルトフレーズ） |
| category | TEXT | NOT NULL | - | カテゴリ（支援領域名） |
| text | TEXT | NOT NULL | - | フレーズテキスト |
| domain_tags | TEXT[] | NOT NULL | `'{}'` | 関連支援領域タグ |
| sort_order | INTEGER | NOT NULL | `0` | 表示順 |
| is_default | BOOLEAN | NOT NULL | `FALSE` | デフォルトフレーズフラグ |
| created_at | TIMESTAMPTZ | NOT NULL | `now()` | 作成日時 |

**制約**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `facility_id` → `facilities(id)`（NULLable）

**インデックス**:
- `idx_phrase_bank_facility_id` ON `facility_id`
- `idx_phrase_bank_category` ON `category`

---

## 4. Row Level Security (RLS) ポリシー

### 4.1 基本方針
- すべてのテーブルでRLSを有効化
- ユーザーは自身の `facility_id` に紐づくデータのみアクセス可能
- `profiles` テーブルから現在ユーザーの `facility_id` を取得してフィルタリング

### 4.2 ポリシー定義

```sql
-- profiles: 自身のプロフィールのみ読み書き可能
CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id);

-- children: 同一施設のデータのみ
CREATE POLICY "Users can view facility children"
  ON children FOR SELECT
  USING (facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid()));

CREATE POLICY "Users can insert facility children"
  ON children FOR INSERT
  WITH CHECK (facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid()));

CREATE POLICY "Users can update facility children"
  ON children FOR UPDATE
  USING (facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid()));

-- daily_records: 同一施設のデータのみ
CREATE POLICY "Users can view facility records"
  ON daily_records FOR SELECT
  USING (facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid()));

CREATE POLICY "Users can insert facility records"
  ON daily_records FOR INSERT
  WITH CHECK (facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid()));

CREATE POLICY "Users can update facility records"
  ON daily_records FOR UPDATE
  USING (facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid()));

CREATE POLICY "Users can delete facility records"
  ON daily_records FOR DELETE
  USING (facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid()));

-- phrase_bank: 同一施設 + デフォルトフレーズ
CREATE POLICY "Users can view phrases"
  ON phrase_bank FOR SELECT
  USING (
    facility_id IS NULL OR
    facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid())
  );

-- attendances: 同一施設のデータのみ
CREATE POLICY "Users can manage facility attendances"
  ON attendances FOR ALL
  USING (facility_id = (SELECT facility_id FROM profiles WHERE id = auth.uid()));
```

---

## 5. データ量見積もり

| テーブル | 1施設あたり年間レコード数（想定） | 備考 |
|---|---|---|
| facilities | 1 | 固定 |
| profiles | 〜20 | スタッフ数 |
| children | 〜100 | 累積（論理削除含む） |
| daily_records | 〜7,500 | 30人 × 250日/年 |
| attendances | 〜7,500 | 30人 × 250日/年 |
| phrase_bank | 〜200 | デフォルト + カスタム |

---

## 6. バックアップ・リカバリ

| 項目 | 内容 |
|---|---|
| 自動バックアップ | Supabase Pro プラン: 日次バックアップ（7日間保持） |
| ポイントインタイムリカバリ | Supabase Pro プラン: 対応 |
| 手動エクスポート | Supabase Dashboard からSQL/CSVエクスポート可能 |
