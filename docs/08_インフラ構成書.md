# インフラ構成書

## プロジェクト名
**ぱっと記録（Patto Kiroku）**

---

## 1. インフラ全体構成

```
┌──────────────────────────────────────────────────┐
│                   インターネット                   │
└───────────────┬──────────────────┬────────────────┘
                │                  │
    ┌───────────▼──────┐  ┌───────▼────────────┐
    │   Vercel CDN     │  │   Supabase Cloud   │
    │   (Edge Network) │  │                    │
    │                  │  │  ┌──────────────┐  │
    │  ┌────────────┐  │  │  │  Auth Server │  │
    │  │ Next.js    │  │  │  └──────────────┘  │
    │  │ App Server │──┼──┤                    │
    │  │            │  │  │  ┌──────────────┐  │
    │  └────────────┘  │  │  │ PostgreSQL   │  │
    │                  │  │  │ (RLS有効)     │  │
    │  ┌────────────┐  │  │  └──────────────┘  │
    │  │ Static     │  │  │                    │
    │  │ Assets     │  │  │  ┌──────────────┐  │
    │  └────────────┘  │  │  │ PostgREST    │  │
    └──────────────────┘  │  │ (REST API)   │  │
                          │  └──────────────┘  │
                          └────────────────────┘
```

---

## 2. サービス構成

### 2.1 ホスティング（Vercel）

| 項目 | 内容 |
|---|---|
| プラン | Hobby（個人） / Pro（本番） |
| リージョン | 自動（エッジ） |
| フレームワーク | Next.js（自動最適化） |
| デプロイ方式 | Git 連携（main ブランチへの push で自動デプロイ） |
| カスタムドメイン | 設定可能 |
| SSL/TLS | 自動（Let's Encrypt） |
| CDN | Vercel Edge Network（グローバル） |

### 2.2 バックエンド（Supabase）

| 項目 | 内容 |
|---|---|
| プラン | Free / Pro |
| リージョン | Northeast Asia（東京） |
| データベース | PostgreSQL 15 |
| 認証 | Supabase Auth（GoTrue） |
| API | PostgREST（自動生成REST API） |
| ストレージ | 未使用（将来拡張用） |
| リアルタイム | 未使用（将来拡張用） |

---

## 3. 環境構成

### 3.1 環境一覧

| 環境 | 用途 | Vercel | Supabase |
|---|---|---|---|
| 開発（local） | ローカル開発 | `localhost:3000` | 開発用プロジェクト |
| プレビュー | PRレビュー | 自動生成URL | 開発用プロジェクト |
| 本番 | ユーザー向け | カスタムドメイン | 本番用プロジェクト |

### 3.2 環境変数

| 変数名 | 開発 | 本番 | 説明 |
|---|---|---|---|
| `NEXT_PUBLIC_SUPABASE_URL` | 開発用URL | 本番用URL | Supabase プロジェクトURL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | 開発用キー | 本番用キー | 公開匿名キー |

---

## 4. デプロイフロー

### 4.1 CI/CD パイプライン

```
開発者のローカル環境
  ↓ git push
GitHub リポジトリ
  ↓ Webhook
Vercel ビルドパイプライン
  ├── 依存関係インストール (npm install)
  ├── TypeScript型チェック
  ├── ESLint チェック
  ├── Next.js ビルド (next build)
  └── デプロイ
      ├── main ブランチ → 本番環境
      └── その他ブランチ → プレビュー環境
```

### 4.2 デプロイコマンド

```bash
# ローカルでの手動デプロイ（必要時）
npx vercel          # プレビューデプロイ
npx vercel --prod   # 本番デプロイ

# 通常は GitHub 連携で自動デプロイ
git push origin main  # → 本番自動デプロイ
```

---

## 5. スケーラビリティ

### 5.1 現在の制限（Free プラン）

| リソース | Vercel Free | Supabase Free |
|---|---|---|
| 帯域幅 | 100GB/月 | 5GB/月 |
| サーバーレス関数実行 | 100GB-hours/月 | - |
| ビルド時間 | 6,000分/月 | - |
| データベースサイズ | - | 500MB |
| 月間アクティブユーザー | - | 50,000 |
| API リクエスト | - | 無制限 |
| 同時接続 | - | 200 |

### 5.2 スケールアップパス

| フェーズ | ユーザー規模 | 推奨プラン |
|---|---|---|
| PoC・テスト | 〜5施設 | Vercel Hobby + Supabase Free |
| 初期運用 | 〜20施設 | Vercel Pro + Supabase Pro |
| 本格運用 | 20施設〜 | Vercel Pro + Supabase Pro（スケールアップ） |

---

## 6. 監視・アラート

### 6.1 監視項目

| 項目 | ツール | 閾値 |
|---|---|---|
| Webサイト死活監視 | Vercel Analytics | ダウン検知 |
| API レスポンスタイム | Supabase Dashboard | > 2秒 |
| データベース接続数 | Supabase Dashboard | > 80% |
| ストレージ使用量 | Supabase Dashboard | > 80% |
| ビルドエラー | Vercel Notifications | 失敗時 |

### 6.2 ログ

| ログ種別 | 場所 | 保持期間 |
|---|---|---|
| アプリケーションログ | Vercel Functions Log | 1時間（Free）/ 3日（Pro） |
| APIログ | Supabase API Logs | 7日 |
| 認証ログ | Supabase Auth Logs | 7日 |
| データベースログ | Supabase Database Logs | 7日 |

---

## 7. バックアップ・DR（災害復旧）

### 7.1 バックアップ

| 項目 | Free プラン | Pro プラン |
|---|---|---|
| 自動バックアップ | なし | 日次（7日間保持） |
| ポイントインタイムリカバリ | なし | 対応（7日間） |
| 手動バックアップ | pg_dump でエクスポート可能 | 同左 |

### 7.2 復旧手順
1. Supabase ダッシュボードからバックアップを選択
2. 復元先プロジェクトを指定
3. データを復元
4. Vercel の環境変数を更新（必要時）

---

## 8. ドメイン・DNS設定

### 8.1 ドメイン構成（本番運用時）

| サブドメイン | 用途 | 指向先 |
|---|---|---|
| `app.example.com` | Webアプリケーション | Vercel |
| - | Supabase API | Supabase自動URL |

### 8.2 DNS設定
```
app.example.com  CNAME  cname.vercel-dns.com
```
